# This is a sample build configuration for JavaScript.
# Check our guides at https://confluence.atlassian.com/x/14UWN for more examples.
# Only use spaces to indent your .yml configuration.
# -----
# You can specify a custom docker image from Docker Hub as your build environment.
image: node:latest
pipelines:
  branches:
    master:
      - step:
          caches:
            - node
          script:
            # Get an oauth access token using the client credentials, parsing out the token with jq.
            - apt-get update && apt-get install -y curl jq zip
            - >
              export BB_TOKEN=$(curl -s -X POST -u "${CLIENT_ID}:${CLIENT_SECRET}" \
                https://bitbucket.org/site/oauth2/access_token \
                -d grant_type=client_credentials -d scopes="repository"| jq --raw-output '.access_token')
            # Configure git to use the oauth token.
            - git remote set-url origin "https://x-token-auth:${BB_TOKEN}@bitbucket.org/${BITBUCKET_REPO_OWNER}/${BITBUCKET_REPO_SLUG}"
            # Install only necessary packages
            - npm install @semantic-release/changelog@6.0.1 @semantic-release/commit-analyzer@9.0.2 @semantic-release/exec@6.0.3 @semantic-release/git@10.0.1 @semantic-release/npm@9.0.1 @semantic-release/release-notes-generator@10.0.3 chalk@4.1.2 columnify@1.5.4 commander@8.2.0 commitizen@4.2.5 conventional-changelog-cli@2.2.2 conventional-changelog-conventionalcommits@5.0.0 conventional-changelog-writer@5.0.1 inquirer@8.2.0 minimist@1.2.6 replace-in-file@6.3.1 semantic-release-version-bump@1.4.1 semantic-release@19.0.3 semver@7.3.5 semver@7.3.5 yaml@1.10.2 -E -D
            - chmod +x ./docs/wordpress-md.js
            - npm link
            - npx semantic-release --debug
      - parallel:
        - step:
            name: Deploy to Bitbucket downloads
            deployment: production
            script:
              - pipe: atlassian/bitbucket-upload-file:0.3.2
                variables:
                  BITBUCKET_USERNAME: '${APP_USER}'
                  BITBUCKET_APP_PASSWORD: '${APP_PASSWORD}'
                  FILENAME: ${BITBUCKET_REPO_SLUG}.zip

        - step:
            name: Deploy to digital.riester
            deployment: production
            script:
              - pipe: atlassian/ftp-deploy:0.3.7
                variables:
                  USER: ${FTP_USERNAME}
                  PASSWORD: ${FTP_PASSWORD}
                  SERVER: ${FTP_HOST}
                  REMOTE_PATH: ${FTP_PATH}
                  LOCAL_PATH: ${BITBUCKET_REPO_SLUG}.zip
